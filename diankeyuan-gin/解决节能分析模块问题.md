# 节能分析模块图表不显示问题解决指南

## 问题描述
节能分析模块中的用电趋势图表无法显示，前端报错：
```
GET http://localhost:8080/express/energy-saving/chart?building=A&timeType=yearly 500 (Internal Server Error)
```

后端Node.js服务报错：
```
Access denied for user 'root'@'172.17.0.1' (using password: YES)
```

## 问题根本原因
1. **MySQL权限问题**：MySQL拒绝来自Docker网关IP地址 `172.17.0.1` 的连接
2. **用户权限配置不完整**：root用户没有被授权从该IP地址连接

## 解决方案

### 方法1：使用批处理脚本自动修复（推荐）
1. 双击运行 `fix_mysql_permissions.bat` 文件
2. 按提示输入MySQL root密码（默认：KE_MYSQL_123456）
3. 等待脚本执行完成

### 方法2：手动执行SQL命令
如果批处理脚本无法运行，请手动执行以下步骤：

1. **打开MySQL命令行或管理工具**（如MySQL Workbench、phpMyAdmin等）

2. **以root身份登录MySQL**

3. **执行以下SQL命令**：
```sql
-- 查看当前权限
SELECT User, Host FROM mysql.user WHERE User = 'root';

-- 添加Docker网关IP权限
CREATE USER IF NOT EXISTS 'root'@'172.17.0.1' IDENTIFIED BY 'KE_MYSQL_123456';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'172.17.0.1' WITH GRANT OPTION;

-- 添加通用权限（推荐）
CREATE USER IF NOT EXISTS 'root'@'%' IDENTIFIED BY 'KE_MYSQL_123456';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;

-- 确保localhost权限正常
ALTER USER 'root'@'localhost' IDENTIFIED BY 'KE_MYSQL_123456';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' WITH GRANT OPTION;

-- 刷新权限
FLUSH PRIVILEGES;

-- 验证权限
SELECT User, Host FROM mysql.user WHERE User = 'root';
```

### 方法3：修改MySQL配置文件
如果上述方法仍不生效，可以修改MySQL配置文件：

1. 找到MySQL配置文件 `my.cnf` 或 `my.ini`
2. 在 `[mysqld]` 段落添加：
```
bind-address = 0.0.0.0
skip-name-resolve
```
3. 重启MySQL服务

## 验证修复结果

### 1. 重启服务
```bash
# 进入nodejs目录
cd nodejs

# 重启Node.js服务
npm start
# 或者
node app.js
```

### 2. 重启前端开发服务器
```bash
# 进入web目录
cd web

# 启动前端服务
npm run serve
# 或者
npm run dev
```

### 3. 测试功能
1. 打开浏览器访问前端应用
2. 进入节能分析模块
3. 选择建筑物（A座、B座或C座）
4. 切换时间视图（日、月、年）
5. 检查图表是否正常显示

## 常见问题

### Q1: 执行SQL命令时提示权限不足
**A**: 确保使用MySQL root账户登录，如果忘记密码，需要重置MySQL root密码。

### Q2: 修复后仍然报错
**A**: 
1. 检查MySQL服务是否正常运行
2. 确认数据库名称和连接配置是否正确
3. 检查防火墙是否阻止了连接
4. 重启Node.js服务和MySQL服务

### Q3: 找不到MySQL命令行工具
**A**: 
1. 检查MySQL是否正确安装
2. 将MySQL bin目录添加到系统PATH环境变量
3. 或者使用MySQL Workbench等图形化工具

### Q4: Docker相关问题
**A**: 
1. 如果使用Docker部署，确保容器网络配置正确
2. 检查Docker容器是否能访问宿主机的MySQL服务
3. 考虑使用Docker内部网络或host网络模式

## 技术说明

### 错误IP地址 172.17.0.1 的含义
- 这是Docker默认网桥的网关地址
- 当Node.js服务在Docker容器中运行时，会从这个IP连接宿主机的MySQL
- MySQL需要明确授权这个IP地址的连接权限

### 项目架构
```
前端(Vue.js:8080) → Vite代理(/express) → Node.js服务(3000) → MySQL数据库(3306)
                                      ↓
                              PostgreSQL数据库(5432)
```

权限修复完成后，整个数据流程应该能够正常工作。 