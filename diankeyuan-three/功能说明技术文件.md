# D座模型适配技术文档

## 1. 概述

本文档详细描述了在三维可视化系统中为D座模型添加显示隐藏、标签渲染等功能的实现过程。D座模型的功能与A座和B座模型保持一致，包括模型的加载、显示、隐藏以及标签的渲染和交互功能。

## 2. 实现功能

D座模型实现了以下功能：

- 模型的加载与初始化
- 模型的显示与隐藏
- 模型标签的渲染
- 标签的点击交互
- 与其他模型（A座、B座）的联动切换

## 3. 技术实现

### 3.1 模型加载

D座模型通过`loaderModel.js`中的模型加载器进行加载：

```javascript
{
  type: 'gltf',
  url: 'model/D-room/D-room.gltf',
  onLoad: (object) => {
    // 保存模型但不添加到场景
    app.dRoomModel = object.scene;
    
    // 缩小模型0.3倍
    app.dRoomModel.scale.set(0.3, 0.3, 0.3);
    
    // 隐藏模型
    app.dRoomModel.visible = false;
    
    console.log('D-room模型加载完成');
  }
}
```

### 3.2 模型显示功能
### $env:NODE_OPTIONS="--openssl-legacy-provider"
在`floorManage.js`中添加了`showDRoomModel`函数，用于显示D座模型：

```javascript
/**
 * 显示D座模型
 * @param {*} app 
 */
function showDRoomModel(app) {
  // 隐藏主模型
  if (app.model) {
    app.model.visible = false;
  }

  // 隐藏A座模型（如果存在）
  if (app.aRoomModel) {
    app.aRoomModel.visible = false;
  }

  // 隐藏B座模型（如果存在）
  if (app.bRoomModel) {
    app.bRoomModel.visible = false;
  }

  // 显示D座模型
  if (app.dRoomModel) {
    app.dRoomModel.visible = true;

    // 将D座模型添加到场景（如果还没有添加）
    if (!app.dRoomModel.parent) {
      app.scene.add(app.dRoomModel);
    }

    // 使用flyTo方法平滑过渡到新的相机位置
    app.flyTo({
      position: [24.151990295168915, 100.26721464448161, -122.52672864267403],
      controls: [-24.595566220945525, 5.193444765493946, -7.445519158492129],
      duration: 1000,
      done: () => {
        console.log('D座模型视角切换完成');
      }
    });

    console.log('D座模型已显示');
  } else {
    console.warn('D座模型未加载');
  }
  
  // 为D座模型创建标签
  roomD.forEach(config => {
    // 根据triggerModel名称在dRoomModel中查找对应的模型 
    let triggerObj = app.dRoomModel.getObjectByName(config.triggerModel);
    if (triggerObj) {
      // 获取模型的世界位置，并向上偏移一定距离
      let position = Object.values(app.getModelWorldPostion(triggerObj));
      position[1] += 10;
      // 构造标签html，内容为配置的id，内联绑定点击事件
      const html = `<div class="floorText-3d animated fadeIn" id="triggerLabel-${config.id}" position="${position}" onclick="window.triggerLabelClick(event, '${config.id}', 'D')"><p class="text">${config.id}</p></div>`;
      // 添加到CSS3D场景中
      app.instance.add({
        parent: app.controlGroup,
        cssObject: CSS3DSprite,
        name: "triggerLabel-" + config.id,
        element: html,
        position: position,
        scale: [0.05, 0.05, 0.05]
      });
    }
  });
}
```

### 3.3 模型映射初始化

在`initModelMaps`函数中添加了D座模型的映射：

```javascript
function initModelMaps() {
  if (modelConfigMap !== null) return; // 已初始化则直接返回
  modelConfigMap = {};
  modelGroupMap = {};
  // 针对每个配置，triggerModel已经改为字符串了，直接建立映射
  roomA.forEach(config => {
    modelConfigMap[config.triggerModel] = config;
    modelGroupMap[config.triggerModel] = config.id; // 建立模型名到组ID的映射
  });
  
  // 添加D座模型的映射
  roomD.forEach(config => {
    modelConfigMap[config.triggerModel] = config;
    modelGroupMap[config.triggerModel] = config.id; // 建立模型名到组ID的映射
  });
  
  console.log('模型映射表已初始化');
}
```

### 3.4 楼层文本点击事件

在`createFloorText`函数中添加了D座模型的点击事件处理：

```javascript
textDom.onclick = () => {
  console.log(textDom.id);
  if (textDom.id === 'a座') {
    // 隐藏标签
    destroyControlGroup(window.app, 'floorText-3d');

    // 调整相机的远裁剪面
    app.camera.far = 100000;  // 增加远裁剪面距离
    app.camera.updateProjectionMatrix();  // 更新相机投影矩阵

    // 显示预加载的A-room模型
    showARoomModel(app);
  } else if (textDom.id === 'b座') {
    // 隐藏标签
    destroyControlGroup(window.app, 'floorText-3d');

    // 调整相机的远裁剪面
    app.camera.far = 100000;
    app.camera.updateProjectionMatrix();

    // 显示预加载的B-room模型
    showBRoomModel(app);
  } else if (textDom.id === 'd座') {
    // 隐藏标签
    destroyControlGroup(window.app, 'floorText-3d');

    // 调整相机的远裁剪面
    app.camera.far = 100000;
    app.camera.updateProjectionMatrix();

    // 显示预加载的D-room模型
    showDRoomModel(app);
  } else {
    // 原有的其他楼层点击逻辑
    // ...
  }
};
```

### 3.5 标签点击事件处理

修改了`window.triggerLabelClick`函数，添加了对D座模型的支持：

```javascript
window.triggerLabelClick = function (event, id, building) {
  event.stopPropagation();
  console.log('triggerLabelClick 被调用, id:', id, 'building:', building);
  let config;

  building = building || 'A';

  if (building === 'A') {
    config = roomA.find(item => item.id === id);
  } else if (building === 'B') {
    config = roomB.find(item => item.id === id);
  } else if (building === 'D') {
    config = roomD.find(item => item.id === id);
  } else {
    console.warn(`未知的楼座: ${building}`);
    return;
  }

  if (config) {
    // 更新当前楼座
    window.currentBuilding = building;
    // 无论是点击同一座还是另一座的标签，都直接发送showBox事件，传入新的配置
    EventBus.$emit('showBox', config);
  } else {
    console.warn(`未找到ID为 ${id} 的配置`);
  }
};
```

## 4. 配置数据

D座模型的配置数据在`boxConfig.js`中定义：

```javascript
export const roomD = [
    {
        id: '11AL1',
        triggerModel: '立方体3317',
        equipmentList: [
            {
                id: '11AL1-1',
                title: '主进柜',
                img: '/model-img/boxC.png'
            },
        ]
    },
    // 更多配置...
];
```

## 5. 注意事项

1. 相机位置设置：目前D座模型使用了与B座模型相同的相机位置，可能需要根据实际情况进行调整。

2. 光照设置：可以参考A座和B座模型的光照设置，为D座模型添加专用光源，以提升视觉效果。

3. 性能优化：当切换到D座模型时，应确保隐藏其他模型，以减少渲染压力。

## 6. 未来扩展

1. 可以为D座模型添加更多交互功能，如模型的高亮、动画效果等。

2. 可以优化标签的显示方式，如根据相机距离动态调整标签大小。

3. 可以添加更多的模型信息展示，如设备状态、实时数据等。

## 7. 总结

通过以上实现，D座模型已经具备了与A座和B座模型相同的功能，包括模型的显示隐藏、标签渲染和交互功能。这种模块化的实现方式使得系统可以方便地扩展更多的模型和功能。
